name: ğŸš€ Deploy to Production

on:
  push:
    branches: [master, main]
    paths:
      - 'src/**'
      - 'supabase/**'
      - 'package.json'
  workflow_dispatch:  # Permite deploy manual

env:
  NODE_VERSION: '20'
  WORKING_DIR: '.'

jobs:
  # ==========================================
  # JOB 1: DEPLOY FRONTEND
  # ==========================================
  deploy-frontend:
    name: ğŸŒ Deploy Frontend to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: production
      url: https://jurify.com.br

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ§ª Run tests
        run: npm test -- --run
        env:
          CI: true

      - name: ğŸ—ï¸ Build production
        run: npm run build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

      - name: ğŸ’¾ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist
          retention-days: 7

      # Deploy para Vercel
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
        if: ${{ secrets.VERCEL_TOKEN != '' }}

  # ==========================================
  # JOB 2: DEPLOY SUPABASE EDGE FUNCTIONS
  # ==========================================
  deploy-edge-functions:
    name: âš¡ Deploy Edge Functions
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: ğŸ“¦ Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/

      - name: ğŸ”— Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: âš¡ Deploy Edge Functions
        run: |
          echo "ğŸš€ Deploying edge functions..."
          supabase functions deploy --no-verify-jwt || echo "âš ï¸ Some functions failed"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸ” Set Edge Function secrets
        run: |
          echo "ğŸ” Setting secrets..."
          supabase secrets set \
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }} \
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }} \
            EVOLUTION_API_URL=${{ secrets.EVOLUTION_API_URL }} \
            EVOLUTION_API_KEY=${{ secrets.EVOLUTION_API_KEY }} \
            ZAPSIGN_API_TOKEN=${{ secrets.ZAPSIGN_API_TOKEN }} \
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} \
            --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          echo "âœ… Secrets configured"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: true

  # ==========================================
  # JOB 3: RUN DATABASE MIGRATIONS
  # ==========================================
  deploy-migrations:
    name: ğŸ—„ï¸ Run Database Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment:
      name: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/

      - name: ğŸ”— Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸ—„ï¸ Run migrations
        run: |
          echo "ğŸ—„ï¸ Running pending migrations..."
          supabase db push || echo "âš ï¸ No new migrations"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # ==========================================
  # JOB 4: SMOKE TESTS
  # ==========================================
  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-frontend, deploy-edge-functions]
    environment:
      name: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ” Health check - Frontend
        run: |
          echo "ğŸ” Checking frontend health..."
          curl -f -s -o /dev/null -w "%{http_code}" https://jurify.app || echo "âš ï¸ Frontend nÃ£o respondeu"
        continue-on-error: true

      - name: ğŸ” Health check - Edge Functions
        run: |
          echo "ğŸ” Checking edge functions..."
          curl -f "${{ secrets.VITE_SUPABASE_URL }}/functions/v1/health-check" \
            -H "Authorization: Bearer ${{ secrets.VITE_SUPABASE_ANON_KEY }}" || echo "âš ï¸ Health check failed"
        continue-on-error: true

      - name: ğŸ“Š Report deployment
        run: |
          echo "âœ… Deploy completed!"
          echo "ğŸŒ Frontend: https://jurify.app"
          echo "âš¡ Edge Functions: Deployed"
          echo "ğŸ—„ï¸ Migrations: Applied"

  # ==========================================
  # JOB 5: NOTIFICATION
  # ==========================================
  notify:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    if: always()

    steps:
      - name: ğŸ“§ Send notification
        run: |
          echo "ğŸ“¢ Deploy notification:"
          echo "Status: ${{ needs.smoke-tests.result }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          # Aqui vocÃª pode adicionar integraÃ§Ã£o com Slack, Discord, etc.
